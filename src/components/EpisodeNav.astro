---
import type { CollectionEntry } from "astro:content";
import { getPath } from "@/utils/getPath";
import IconChevronLeft from "@/assets/icons/IconChevronLeft.svg";
import IconChevronRight from "@/assets/icons/IconChevronRight.svg";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const { episode, series } = post.data;

// Only show episode navigation if post is part of a series
if (!series || !episode) {
  return null;
}

// Find all posts in the same series, sorted by episode number
const seriesPosts = posts
  .filter(p => p.data.series === series && p.data.episode)
  .sort((a, b) => (a.data.episode || 0) - (b.data.episode || 0));

// Find prev/next episodes in the series
const currentIndex = seriesPosts.findIndex(p => p.id === post.id);
const prevEpisode = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null;
const nextEpisode = currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null;

// Don't render if no prev/next episodes
if (!prevEpisode && !nextEpisode) {
  return null;
}
---

<div class="episode-nav-container my-8 rounded-lg border-2 border-accent/20 bg-accent/5 p-6">
  <div class="mb-4 text-center">
    <span class="text-sm font-semibold uppercase tracking-wider text-accent/70">{series}</span>
    <div class="mt-1 text-xs text-foreground/60">Episode {episode} of {seriesPosts.length}</div>
  </div>

  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
    {prevEpisode && (
      <a
        href={getPath(prevEpisode.id, prevEpisode.filePath)}
        class="flex items-center gap-2 rounded-md border border-accent/30 bg-background p-4 transition-all hover:border-accent hover:bg-accent/10"
      >
        <IconChevronLeft class="flex-none text-accent rtl:rotate-180" />
        <div class="min-w-0">
          <div class="text-xs font-medium uppercase tracking-wide text-accent/70">Previous Episode</div>
          <div class="mt-1 truncate text-sm font-semibold text-foreground">
            Episode {prevEpisode.data.episode}: {prevEpisode.data.title}
          </div>
        </div>
      </a>
    )}

    {nextEpisode && (
      <a
        href={getPath(nextEpisode.id, nextEpisode.filePath)}
        class:list={[
          "flex items-center justify-end gap-2 rounded-md border border-accent/30 bg-background p-4 text-end transition-all hover:border-accent hover:bg-accent/10",
          { "sm:col-start-2": prevEpisode }
        ]}
      >
        <div class="min-w-0">
          <div class="text-xs font-medium uppercase tracking-wide text-accent/70">Next Episode</div>
          <div class="mt-1 truncate text-sm font-semibold text-foreground">
            Episode {nextEpisode.data.episode}: {nextEpisode.data.title}
          </div>
        </div>
        <IconChevronRight class="flex-none text-accent rtl:rotate-180" />
      </a>
    )}
  </div>
</div>
